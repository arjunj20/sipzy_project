{% extends "admin_base.html" %}
{% load static %}
{% block title %}Edit Product{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
  .thumb { width: 90px; height: 90px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
  .img-card { width: 160px; height: 160px; object-fit: cover; border-radius: 10px; }
</style>
{% endblock %}

{% block content %}
<div class="p-6 max-w-6xl mx-auto">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h1 class="text-2xl font-bold">Edit Product</h1>
      <p class="text-gray-500">{{ product.name }}</p>
    </div>
    <a href="{% url 'product_list' %}" class="px-4 py-2 border rounded-lg">Back</a>
  </div>

  <!-- Product Form -->
  <div class="bg-white p-6 rounded-xl shadow mb-6">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="edit_product">

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Name</label>
          <input name="name" value="{{ product.name }}" class="w-full mt-1 border rounded-lg px-3 py-2">
        </div>

        <div>
          <label class="text-sm">Brand</label>
          <select name="brand" class="w-full mt-1 border rounded-lg px-3 py-2">
            {% for b in brands %}
              <option value="{{ b.id }}" {% if product.brand_id == b.id %}selected{% endif %}>
                {{ b.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label class="text-sm">Category</label>
          <select name="category" class="w-full mt-1 border rounded-lg px-3 py-2">
            {% for c in categories %}
              <option value="{{ c.id }}" {% if product.category_id == c.id %}selected{% endif %}>
                {{ c.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="flex items-center mt-6">
          <input type="checkbox" name="is_active" {% if product.is_active %}checked{% endif %}>
          <span class="ml-2">Active</span>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm">Description</label>
          <textarea name="description" rows="3" class="w-full mt-1 border rounded-lg px-3 py-2">
{{ product.description }}</textarea>
        </div>
      </div>

      <button class="mt-4 px-5 py-2 bg-blue-600 text-white rounded-lg">
        Save Product
      </button>
    </form>
  </div>

  <!-- Images -->
  <div class="bg-white p-6 rounded-xl shadow">
    <h2 class="font-semibold mb-4">Product Images</h2>

    <!-- Existing -->
    <div class="flex gap-4 flex-wrap mb-6">
      {% for img in product.images.all %}
        <div class="relative">
          <img src="{{ img.image.url }}" class="img-card">
          <form method="post" action="{% url 'product_image_delete' img.id %}" class="absolute top-2 right-2">
            {% csrf_token %}
            <button class="bg-red-500 text-white px-2 rounded">×</button>
          </form>
        </div>
      {% endfor %}
    </div>

    <!-- Upload -->
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_images">

      <input id="imageInput" type="file" accept="image/*" multiple>
      <div id="hiddenInputs"></div>

      <div id="preview" class="flex gap-3 flex-wrap mt-4"></div>

      <button class="mt-4 px-5 py-2 bg-green-600 text-white rounded-lg">
        Add Images
      </button>
    </form>
  </div>
</div>

<!-- Crop Modal -->
<div id="cropModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
  <div class="bg-white p-4 rounded-xl w-full max-w-3xl">
    <h3 class="font-semibold mb-2">
      Crop Image <span id="counter"></span>
    </h3>

    <div class="h-[60vh] bg-gray-100 rounded overflow-hidden">
      <img id="cropImg">
    </div>

    <div class="flex justify-between mt-4">
      <div>
        <button id="zoomIn" class="border px-3 py-1 rounded">+</button>
        <button id="zoomOut" class="border px-3 py-1 rounded">−</button>
        <button id="rotate" class="border px-3 py-1 rounded">↻</button>
      </div>
      <button id="done" class="bg-blue-600 text-white px-4 py-2 rounded">
        Done
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script>
let files = [], cropped = [], index = 0, cropper;

const input = document.getElementById('imageInput');
const modal = document.getElementById('cropModal');
const img = document.getElementById('cropImg');
const counter = document.getElementById('counter');
const hidden = document.getElementById('hiddenInputs');
const preview = document.getElementById('preview');

input.onchange = e => {
  files = [...e.target.files];
  cropped = [];
  index = 0;
  preview.innerHTML = '';
  hidden.innerHTML = '';
  openCrop();
};

function openCrop() {
  if (index >= files.length) {
    cropped.forEach(f => {
      const i = document.createElement('input');
      i.type = 'file';
      i.name = 'images[]';
      const dt = new DataTransfer();
      dt.items.add(f);
      i.files = dt.files;
      hidden.appendChild(i);

      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.className = 'thumb';
      preview.appendChild(img);
    });
    return;
  }

  const r = new FileReader();
  r.onload = e => {
    img.src = e.target.result;
    modal.classList.remove('hidden');
    cropper?.destroy();
    cropper = new Cropper(img, { aspectRatio: 1 });
    counter.textContent = `(${index + 1}/${files.length})`;
  };
  r.readAsDataURL(files[index]);
}

document.getElementById('done').onclick = () => {
  cropper.getCroppedCanvas({ width: 1000, height: 1000 }).toBlob(b => {
    cropped.push(new File([b], `img_${index}.jpg`, { type: 'image/jpeg' }));
    cropper.destroy();
    modal.classList.add('hidden');
    index++;
    openCrop();
  });
};

zoomIn.onclick = () => cropper.zoom(0.1);
zoomOut.onclick = () => cropper.zoom(-0.1);
rotate.onclick = () => cropper.rotate(90);
</script>
{% endblock %}
